<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cadastro do Cliente</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        background-color: #f8f9fa;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
      }
      .cadastro-card {
        width: 100%;
        max-width: 450px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        padding: 2rem;
      }
      .logo {
        width: 100px;
        height: 100px;
        object-fit: cover;
        border-radius: 50%;
        margin-bottom: 1rem;
      }
    </style>
  </head>
  <body>
    <div class="cadastro-card text-center">
      <img id="logoLoja" src="" alt="Logo da Loja" class="logo" />
      <h4 id="nomeLoja" class="mb-4">Carregando loja...</h4>

      <form id="formCadastro">
        <input type="hidden" id="loja_id" name="loja_id" />

        <div class="mb-3 text-start">
          <label for="nome" class="form-label">Nome completo:</label>
          <input
            type="text"
            id="nome"
            name="nome"
            class="form-control"
            placeholder="Digite seu nome completo"
            required
          />
        </div>

        <div class="mb-3 text-start">
          <label for="email" class="form-label">Email:</label>
          <input
            type="email"
            id="email"
            name="email"
            class="form-control"
            placeholder="Digite seu email"
            required
          />
        </div>

        <div class="mb-3 text-start">
          <label for="cpf" class="form-label">CPF:</label>
          <input
            type="text"
            id="cpf"
            name="cpf"
            class="form-control"
            placeholder="Digite seu CPF"
          />
        </div>

        <div class="mb-3 text-start">
          <label for="telefone" class="form-label">Telefone:</label>
          <input
            type="text"
            id="telefone"
            name="telefone"
            class="form-control"
            placeholder="Digite seu telefone"
            required
          />
        </div>

        <div class="mb-3 text-start">
          <label for="senha" class="form-label">Senha:</label>
          <input
            type="password"
            id="senha"
            name="senha"
            class="form-control"
            placeholder="Crie uma senha"
            required
          />
        </div>

        <button type="submit" class="btn btn-primary w-100">Cadastrar</button>

        <div class="mt-3">
          <p class="mb-0">
            Já tem conta?
            <a href="#" id="linkLogin">Voltar ao login</a>
          </p>
        </div>
      </form>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", async () => {
        const params = new URLSearchParams(window.location.search);
        const lojaParam = params.get("loja");
        const nomeLojaEl = document.getElementById("nomeLoja");
        const logoLojaEl = document.getElementById("logoLoja");
        const inputLojaId = document.getElementById("loja_id");

        if (!lojaParam) {
          nomeLojaEl.textContent = "Loja não especificada";
          return;
        }

        try {
          const res = await fetch(
            `php/get_loja.php?loja=${encodeURIComponent(lojaParam)}`
          );
          const data = await res.json();

          if (data.erro) {
            nomeLojaEl.textContent = data.erro;
            return;
          }

          if (data.sucesso && data.loja) {
            const loja = data.loja;
            nomeLojaEl.textContent = `Bem-vindo à ${loja.nome}`;
            inputLojaId.value = loja.id;

            if (loja.logo) {
              logoLojaEl.src = `data:image/png;base64,${loja.logo}`;
            } else {
              logoLojaEl.src = "../imagens/default_logo.png";
            }
          } else {
            nomeLojaEl.textContent = "Erro ao carregar loja.";
          }

          const linkLogin = document.getElementById("linkLogin");
          if (linkLogin && lojaParam) {
            linkLogin.href = `login.html?loja=${encodeURIComponent(lojaParam)}`;
          }
        } catch (err) {
          console.error("Erro ao carregar loja:", err);
          nomeLojaEl.textContent = "Erro ao carregar loja.";
        }

        // ===== Envio via JS =====
        const form = document.getElementById("formCadastro");
        form.addEventListener("submit", async (e) => {
          e.preventDefault();

          const formData = new FormData(form);

          try {
            const res = await fetch("php/cadastro_cliente.php", {
              method: "POST",
              body: formData,
            });

            const data = await res.json();

            if (data.erro) {
              alert(`Erro: ${data.erro}`);
            } else if (data.sucesso) {
              alert(data.mensagem);
              window.location.href = `login.html?loja=${encodeURIComponent(
                lojaParam
              )}`;
            }
          } catch (err) {
            console.error("Erro ao enviar formulário:", err);
            alert("Erro ao enviar formulário.");
          }
        });
      });
    </script>
  </body>
</html>
